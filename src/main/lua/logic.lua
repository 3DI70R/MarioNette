---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Three.
--- DateTime: 10.05.2018 10:40
---

local neural = require("neural")

local logic = {}
logic.event = {}

local eventHandler = {}
local pendingNetworkList = {}
local networkEvaluationResults = {}
local network
local frameCounter = 0
local environment
local saveSlot = savestate.create(2)

function logic.event.onNetworkEvaluated(id, fitness)

end

function logic.addNetworks(networks)
    for i, n in pairs(networks) do
        table.insert(pendingNetworkList, n)
    end

    if network == nil then
        switchToNextNetwork()
    end
end

function logic.setEventHandler(handler)
    eventHandler = handler
end

function logic.setEnvironment(env)
    environment = env
end

function switchToNextNetwork()
    if #pendingNetworkList > 0 then
        local networkDefinition = pendingNetworkList[1]
        table.remove(pendingNetworkList, 1)
        network = neural.createNetwork(networkDefinition)
        onEvaluationStarted()
    else
        network = nil
    end
end

function storeEvaluationResult(result)
    table.insert(networkEvaluationResults, result)
end

function onEvaluationStarted()
    savestate.load(saveSlot)
    environment.onSimulationReset()
    frameCounter = 0
    outputs = { 0, 0, 0, 0, 0, 0 }
end

function onEvaluationFinished(state)
    logic.event.onNetworkEvaluated(network.id, state.fitness)
    switchToNextNetwork()
end

function logic.simulateFrame()

    if network then
        frameCounter = frameCounter + 1
        environment.onNewFrame(frameCounter)
        local state = environment.getEvaluationState(frameCounter)

        gui.text(16, 16, state.fitness)

        if state.isFinished then
            onEvaluationFinished(state)
        else
            if frameCounter % 5 == 0 then
                local inputs = environment.getInputs()
                outputs = network:evaluate(inputs)
            end

            environment.mapOutputs(outputs)
        end
    end

    emu.frameadvance()

end

return logic
